\chapter{The Echo Web Service}

The Echo Web Service was already presented in the introduction, 
basically as the ground truth to learn if the installation of
the HED is functional. And it was frequently referenced in the previous chapter
on WSDL. In this section, we will implement our own version of the Echo
Web Service.

Its task is to return the content of the received message back to the client.
As a special feature that we introduce solely for educatory purposes, the
service provides two additional operations called ``ordinary'' and ``reverse''.
Depending on the operation chosen by the client, the message gets returned
unmodified or reversed. The goal of this chapter is to deepen the knowledge
on message processing.

The WSDL file that specifies the here presented Echo Web Service is shown in
Listing~\ref{lst:echo_wsdl}.


% moved WSDL description into separate Chapter. See folder tex_wsdl.

\subsection{The SOAP Fault Message}

A SOAP fault message is always located within the body element and can appear only once. 
It indicates error messages in case the port type \textit{solicit-response} (input, output, fault) has been chosen.
An element called \textit{fault} encapsulates different types of elements that describe the fault.
These elements are listed in Table~\ref{tbl:fault_elements}.
\begin{table}[h]
 \centering
 \caption{Elements of the fault message.}
 \label{tbl:fault_elements}
	\begin{tabular*}{\textwidth}[t]{p{2cm}p{13cm}}
	\hline
	\textbf{Element}        & \textbf{Description}\\
	\hline
	\textbf{faultcode} 	& Code which shall identify the fault.\\
	\textbf{faultstring} 	& A human readable explanation of the fault.\\
	\textbf{faultactor} 	& Information about who caused the fault to happen.\\
	\textbf{detail}         & Holds application specific error information.\\
	\hline\\
	\end{tabular*}
\end{table}
The fault code describes the generic class of the fault. The ARC implementation assigns each fault a certain number.
The fault code along with its description is described within the Table~\ref{tbl:faultcode}
\begin{table}[h]
 \centering
 \caption{Possible fault codes.}
 \label{tbl:faultcode}
	\begin{tabular*}{\textwidth}[t]{p{2cm}p{4cm}p{9cm}}
	\hline
	\textbf{Fault code} & \textbf{Error} & \textbf{Description}\\
	\hline
	0 & \textbf{undefined}       & --- \\
	1 & \textbf{unknown}         & Reason for failure couldn't be identified.\\
	2 & \textbf{VersionMismatch} & Found an invalid namespace for the SOAP Envelope element.\\
	3 & \textbf{MustUnderstand}  & The processing of the SOAP header is optional unless the flag mustUnderstand is set ``true''. If, according to that case, the SOAP service is not able to understand the header a fault message with the faultcode MustUnderstand is returned. \\
	4 & \textbf{Client}          & The request message was incorrectly formed or contained incorrect information.\\
	5 & \textbf{Server}          & There was a problem with the server so the message could not proceed \\
	6 & \textbf{DataEncodingUnknown} & The message couldn't be processed due to encoding problems\\
	\hline
	\end{tabular*}
\end{table}

For more information additional tutorials can be found in the appendix or check the internet address~\href{http://www.w3.org/TR/wsdl}{http://www.w3.org/TR/wsdl}.

% a valid service request and the  


% WSDL ist eine Metasprache, mit deren Hilfe die angebotenen Funktionen, Daten, Datentypen und Austauschprotokolle eines Web Service beschrieben werden können. Es werden im Wesentlichen die Operationen definiert, die von außen zugänglich sind, sowie die Parameter und Rückgabewerte dieser Operationen. Im Einzelnen beinhaltet ein WSDL-Dokument funktionelle Angaben zu:

%    * der Schnittstelle
%    * Zugangsprotokoll und Details zum Deployment
%    * Alle notwendigen Informationen zum Zugriff auf den Service, in maschinenlesbarem Format

%Nicht enthalten sind hingegen:

%    * Quality-of-Service-Informationen
%    * Taxonomien/Ontologien zur semantischen Einordnung des Services
\clearpage

\section{Service}

This section presents the implementation of the service defined in the WSDL file of the previous section.
The source code is shown in Listing~\ref{lst:echo_service_cpp}.
The header file will be set aside since it contains only redundant information. 
It can be reread in the source directory that is accompanying the tutorial.
In comparsion with Time Web Service, basically three changes are required.
The first change concerns the constructor and can be found at line~\ref{lst_code:echo_cpp_prefix}.
Two strings are extracted of the server configuration file which are later used to envelope the message before it is returned.
Furthermore, a new method \textit{makeFault} in line~\ref{lst_code:echo_cpp_makeFault} has been introduced which is able to create a fault messages.
Within the method \textit{process} two new code fragments are now extracting and analyzing the incoming message, to be seen at line~\ref{lst_code:echo_cpp_extracting} and \ref{lst_code:echo_cpp_analyzing}.
In case something unexpected happens either will create a SOAP fault message.\\
% Vielleicht noch etwas über das extrahieren der Nachricht schreiben

\lstsetCPP
\lstinputlisting
	[
	label=lst:echo_service_cpp,
	caption={[Implementation of the Echo Web Service.]
	\textbf{Implementation of the Echo Web Service.}}
	]
{../src/services/echoservice/echoservice.cpp}


Again, the HED is configured by an XML file and launched in the same manner as introduced before.
The server configuration file is shown in Listing~\ref{lst:echo_hed_configuration_xml}.
The only change concerns the lines~\ref{lst_code:echo_hed_configuration_xml_pre} and \ref{lst_code:echo_hed_configuration_xml_suf} which specify the \textit{prefix} and \textit{suffix}.
The parameters will be extracted in the constructor of the service and explain nicely how settings can be passed from the server configuration file towards the service.

\lstsetARCHEDXML
\lstinputlisting
	[
	label=lst:echo_hed_configuration_xml, float=htb,
	caption={[Server configuration file of the Echo Web Service]
	\textbf{Server configuration file of the Echo Web Service}}
	]
{../src/services/echoservice/arched_echoservice.xml}





%\lstsetKSH
%\begin{lstlisting}[
%label=lst:invokation_arched_timeservice,float=htb,
%caption={[Transformation in eine uniforme konzentrische Verteilung.]
%         \textbf{Transformation in eine uniforme konzentrische Verteilung.\textcolor{white}{hmf}}}]
%$ arched -c arched_echoservice.xml  && echo jo ||echo n
%\end{lstlisting}



\section{Client}

With the interface of the server gaining complexity, so is the code for the client - for two reasons. Firstly, because the additional arguments need to be filled. Secondly, because of the extra effort to interact with the (here human) user to collect the data which needs to be forwarded to the Echo Web Service. The source code of the client is shown Listing~\ref{lst:client_echo_cpp}.
The parameters are now passed by the command line, to be seen in the lines following line~\ref{lst_code:echo_client_cpp_arguments}.
That code is independent from the ARC library.
The creation of the SOAP client is unchanged from the Echo client's implementation and the request to the server is created in the lines subsequent to line~\ref{lst_code:echo_client_cpp_request}.
It is processed in the code after line~\ref{lst_code:echo_client_cpp_response} in which also the response is received.
The checks of the response have expanded by an additional condition which tests for a fault message, see line~\ref{lst_code:echo_client_cpp_fault}.


\lstsetCPP
\lstinputlisting
	[
	label=lst:client_echo_cpp,
	caption={[Implementation of the client program.]
	\textbf{Implementation of the client program.}}
	]
{../src/clients/echoclient/echoclient.cpp}

\lstsetCPP

The usage of the client is presented in Listing~\ref{lst:invokation_echoservice}.
Three cases of Echo Web Service responses are displayed: ordinary operation, reverse operation and SOAP fault due to an unknown operation.


\lstsetKSH
\begin{lstlisting}[
label=lst:invokation_echoservice, float=!htb,
caption={[Three diffrent invokations of the client program.]
         \textbf{Three diffrent invokations of the client program.}}]
$ ./echoclient http://localhost:60000/echo ordinary text_to_be_transmitted
[ text_to_be_transmitted ]
$ ./echoclient http://localhost:60000/echo reverse text_to_be_transmitted
[ dettimsnart_eb_ot_txet ]
$ ./echoclient http://localhost:60000/echo re2verse text_to_be_transmitted
A SOAP fault occured:
  Fault code:   4
  Fault string: "Unknown operation. Please use "ordinary" or "reverse""
\end{lstlisting}

A few examples of exchanged messages are shown in the Listings~\ref{lst:echoservice_request}, \ref{lst:echoservice_response} and \ref{lst:echoservice_fault}. Listing~\ref{lst:echoservice_request} illustrates a request message using the operation \textit{reverse} while Listing~\ref{lst:echoservice_response} illustrates the corresponding response message.
The last Listing~\ref{lst:echoservice_fault} shows the fault message which is created by the service after the client requested an unknown operation.

\lstsetJUSTXML
\begin{lstlisting}[
label=lst:echoservice_request, float=!htb,
caption={[Request message created by the client.]
         \textbf{Request message created by the client.}}]
<soap-env:Envelope xmlns:echo="urn:echo" xmlns:soap-enc="http://schemas.xmlsoap.org/soap/encoding/" xmlns:soap-env="http://schemas.xmlsoap.org/soap/envelope/" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <soap-env:Body>
    <echo:echoRequest>
      <echo:say operation="reverse">text_to_be_transmitted</echo:say>
    </echo:echoRequest>
  </soap-env:Body>
</soap-env:Envelope>
\end{lstlisting}



\lstsetJUSTXML
\begin{lstlisting}[
label=lst:echoservice_response, float=!htb,
caption={[Response message created by the service.]
         \textbf{Response message created by the service.}}]
<soap-env:Envelope xmlns:echo="urn:echo" xmlns:soap-enc="http://schemas.xmlsoap.org/soap/encoding/" xmlns:soap-env="http://schemas.xmlsoap.org/soap/envelope/" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <soap-env:Body>
    <echo:echoResponse>
      <echo:hear>[ dettimsnart_eb_ot_txet ]</echo:hear>
    </echo:echoResponse>
  </soap-env:Body>
</soap-env:Envelope>
\end{lstlisting}


\lstsetJUSTXML
\begin{lstlisting}[
label=lst:echoservice_fault, float=!htb,
caption={[Fault message created by the service..]
         \textbf{Fault message created by the service.}}]
<soap-env:Envelope xmlns:echo="urn:echo" xmlns:soap-enc="http://schemas.xmlsoap.org/soap/encoding/" xmlns:soap-env="http://schemas.xmlsoap.org/soap/envelope/" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <soap-env:Body>
    <soap-env:Fault>
      <soap-env:faultcode>soap-env:Client</soap-env:faultcode>
      <soap-env:faultstring>Unknown operation. Please use "ordinary" or "reverse"</soap-env:faultstring>
    </soap-env:Fault>
  </soap-env:Body>
</soap-env:Envelope>
\end{lstlisting}







\chapter{Programming concept}

 The main language for the implementation of the functionality of the
 dynamic runtime environment functionality is Perl. And it is solely required (exceptions are the
 integration with the Grid Manager and the Web server) for the Janitor. In
 the pre-web-service implementation the Catalog remains a static web page.
 The Perl code is split into multiple modules as depicted in Figure~\ref{fig:janitorDependencies}. 
 The modules can be separated into two
 functional groups. One addresses the retrieval of information from
 the Catalog's RDF file in the left major branch of the figure. The other
 addresses the process of fetching and installing the packages.

 \begin{landscape}
\begin{figure}[!h]
\vspace{4cm}
 \begin{center} 
%    \resizebox{24cm}{!}{\input{images/dependencies}}
    \includegraphics[width=24cm]{images/dependencies.png}
    \mycaption{Modules of the Janitor and their dependencies}{}
 \end{center} 
\vfill
 \label{fig:janitorDependencies} 
\end{figure}
 \end{landscape}

In order to get a more detailed view on the full functionality of the envisioned system it is suggested to consult the 
Design Document\footnote{\href{http://www.knowarc.eu/documents/Knowarc_D1.1-1_07.pdf}
{http://www.knowarc.eu/documents/Knowarc\_D1.1-1\_07.pdf}}.




\section{States of runtime environments}
A major motivation for the managed, manual initiation of dynamic RE
installation is the subsequent manual verification of the installed
packages -- prior to their use in production.
With an automation of the installation, the verification of
that process shall be performed externally to that process.  At this
time, only the automation of the installation has been implemented.
To reflect the progress the external verification has made, REs
are said to be in states. The current implementation lists
installable REs aside the installed REs in the grid information system,
in order to stimulate grid clients to submit packages. The here described
states will be represented to the clients in upcoming developments.

These states are specific for every compute element (CE) and communicated
between the Janitor and the Execution Service. Table~\ref{tab:states} shows all
possible states, while Figure~\ref{fig:RE_states}
displays the transitions between the states that a Runtime Environment may
be in during its life time at a particular CE. \task{?at a particular CE?}  



\begin{table}[!h]
 \begin{center}
 \begin{tabular}{lp{12cm}}
 State&Description\\
 \hline
 UNAVAILABLE&
	The RE is not available for the BaseSystem (see \ref{sec:rdfschema}) the site uses. \\
 INSTALLABLE&
	The RE is available for the BaseSystem the site uses and it
	will be automatically installed once a job requests it. \\
 INSTALLING/a&
	A job requested the RE and it is currently being installed \\
 INSTALLING/m&
	The RE-adminstrator requested the installation of the RE. Its
	currently being installed. \\
 FAILED&
	The installation process failed. \\
 INSTALLED/a&
	The RE is installed dynamically. \\
 INSTALLED/m&
	The RE ist installed manually by the RE-administrator \\
 BROKEN/m&
	The RE is installed but failed tests of the RE-administrator \\
 VALIDATED/m&
	The RE is installed and successfully passed the tests of the
	RE-administrator \\
 REMOVAL PENDING&
	The RE is still installed but will be removed as soon as
	possible. It is not available to new jobs. \\
 REMOVING&
	The RE is currently being removed. \\
 INSTALLED/s&
	The RE was installed in the traditional way by the site administrator. \\
 BROKEN/s&
	The RE was installed in the traditional way and failed
	validation by the RE-administrator, \\
 VALIDATED/s&
	The RE was installed in the traditional way and was
	successfully verified.
 \\
 \end{tabular}
 \end{center}
 \mycaption{States a Runtime Environment can possibly be in.}{}
 \label{tab:states}
 \end{table}

\begin{figure}[!h]
  \begin{center}
    \includegraphics[width=10cm]{images/RE_states.png}
    \mycaption{Relationships between the possible states
 of Runtime Environments.}{Red arcs represent human interaction.
 The distinction between {\bf /a}, {\bf /m} and {\bf /s}
 states does not need to be visible for all clients.}
    \label{fig:RE_states}
  \end{center}
\end{figure}
 
The manually induced transitions are marked in red, he automated transitions in black.
A transition between states can be induced automatically (i.\,e.\ by the
advent of a job requesting a particular dynamic RE) or manually by the
site's supervisor or an individual with respective rights to use the
Janitor's web service.

Upon presentation of a the package name to a Catalog, from which details about
the package are retrieved, a CE may
classify a package to be \texttt{INSTALLABLE} if all the dependencies
are installable or already \texttt{INSTALLED}. The installation can be
performed manually (\texttt{INSTALLING}/{\bf m}) or in an automated fashion
(\ldots/{\bf a}). Should the installation process return an error, then
the installation has \texttt{FAILED}. Once the installation succeeded,
the installed package is validated for its correctness. Should that
process fail, then the package's state it is said to be \texttt{BROKEN}.

Automatically installed packages can be removed by the automatism. A
manually installed package or one that has failed to be installed,
can only be removed upon manual induction.  The \ldots/{\bf s} states
represent those Runtime Environments that are installed in the original
manual way of RE installation in ARC 0.6.

% Runtime Environment are installed for job idenitified by a certain id.


\section{Job states}

The Janitor manages the states that the runtime environments at a particular
compute element are in. However, it is also most important for the Janitor
to be aware of the jobs that depend on the installtion of a RE. REs still in use
should not be removed until the respective job has completed its computations.
The installation or removal of REs by the Janitor is perceived as a mere
consequene of jobs demanding a RE or not, thus, the communcation between
the job-manager AREX and the Janitor will be performed on that 'job level'.

The Janitor has two states for jobs: \texttt{PREPARED} and \texttt{INITIALIZED}. After a job has been succesfully registered 
in the Janitor, its state will be set to \texttt{PREPARED}. Invalid jobs are not cached. 
After the Janitor is requested to deploy the runtime environment, the state of the job will change to \texttt{INITIALIZED}. If 
an unforeseen exception occures during that process, the Janitor will drop the job from its database and set the affected runtime
environments to the state \texttt{FAILED}.

\section{Integration with AREX}


\newenvironment{note}
{\rule{1ex}{1ex}\hspace{\stretch{1}}}
{\hspace{\stretch{1}}\rule{1ex}{1ex}\\}
\begin{note}
The integration into AREX is not completed yet!
\end{note}
\begin{note}
Thus, there will be bigger changes here in this section\dots
\end{note}


\begin{figure}[!h]
  \begin{center}
    \includegraphics[width=5cm]{images/arex-stages.pdf}
    \mycaption{}{}
    \label{fig:RE_states}
  \end{center}
\end{figure}

\begin{figure}[!h]
  \begin{center}
    \includegraphics[width=12cm]{images/janitor_integration_2nd_edition.pdf}
    \mycaption{}{}
    \label{fig:RE_states}
  \end{center}
\end{figure}

\section{WebService Interface}

Default port number: 55555\\
Client command equal, except assignment of HED.xml\\
 (from /arc1/trunk:12561)

\begin{figure}[!h]
  \begin{center}
    \includegraphics[width=12cm]{images/WS_structure.pdf}
    \mycaption{}{\task{To be translated and beautificated. SVG file is missing!}}
    \label{fig:RE_states}
  \end{center}
\end{figure}

Proposal for SOAP messages:\\
 namespace: dynamicruntime or janitor\\
\task{Create WSDL files for that}
\task{Permission concepts: Depending on certificates. Certain certificates may \texttt{sweep}. Defined in service\_HED.xml. Evaluated in:?? }
\lstsetJUSTXML
\begin{lstlisting}[
        label=lst:SOAPrequest,
        caption={ [Example \textit{arc.conf} settings for janitor.]
                  \textbf{Example \textit{arc.conf} settings for janitor.}}
        ]
<Request action="SEARCH|SWEEP|LIST|DEPLOY|REMOVE|CHECK|REGISTER">
	<Initiator jobid="1234"/>  <!-- Needed for: CHECK|REGISTER|DEPLOY|REMOVE -->
                                  <!-- May contain no jobID in this case a new one will 
                                       be created and returned via the response message-->

	<Runtimeenvironment type="dynamic">      <!-- Needed for: SEARCH|REGISTER-->
		<Package name="APPS/BIO/WEKA-3.4.10"/>
		<Package name="APPS/BIO/WEKA-3.4.11"/>
	</Runtimeenvironment>
                                  <!-- SWEEP and LIST only works, if the TLS-adminstrator identity 
                                       (which is assigned in the arched configuration file) is
                                       to be found by the SecHandler. Both need neither initiator 
                                       nor runtimeenvironment elements -->
</Request>
\end{lstlisting}

\lstsetJUSTXML
\begin{lstlisting}[
        label=lst:SOAPrequest,
        caption={ [Example \textit{arc.conf} settings for janitor.]
                  \textbf{Example \textit{arc.conf} settings for janitor.}}
        ]
<response action="SEARCH|SWEEP|LIST|DEPLOY|REMOVE|CHECK|REGISTER">
	<initiator jobid="1234"/>  <!-- Needed for REMOVE|REGISTER|DEPLOY|CHECK-->
	<result code="0" message="Sucessfully initailized job."> <!-- -->
	<jobs> <!--LIST|CHECK-->
		<job jobid="1234">
			<created>1234567890</created>    <!-- in unix time-->
			<age>0</age>           <!-- in seconds-->
			<runtimeenvironment>
				<package>APPS/BIO/WEKA-3.4.10</package>
			</runtimeenvironment>
			<state>INITIALIZED</state>
		</job>
		<job jobid="4321">
			<created>1234567891</created>
			<age>0</age>
			<package>APPS/BIO/WEKA-3.4.10</package>
			<state>INITIALIZED</state>
			<runtimeenvironmentkey>APPS_BIO_WEKA_3_4_10-835614b62c98c4eb6cb03d74d3161b5d</runtimeenvironmentkey> <!-- at least CHECK -->
			<uses>/nfshome/knowarc/dredesign/src/services/dRE3/perl/spool/runtime/jre__57T1ke1UVz/runtime</uses> <!-- at least CHECK -->
			<uses>/nfshome/knowarc/dredesign/src/services/dRE3/perl/spool/runtime/weka_wHfyytarlE/runtime</uses> <!-- at least CHECK -->
		</job>
	</jobs>

	<runtimeenvironment type="local">      <!-- Needed for: LIST|SEARCH -->
		<package name="APPS/BIO/MUSTANG-3.0-1"/>
		<package name="APPS/BIO/EXONERATE-2.1.0-1"/>
	</runtimeenvironment>

	<runtimeenvironment type="dynamic">      <!-- Needed for: LIST -->
		<package name="APPS/BIO/WEKA-3.4.11">
			<state>INSTALLED_A</state>
			<lastused>1234567890</lastused>
			<jobid>1234</jobid>
		</package>
		<package name="APPS/BIO/WEKA-3.4.10">
			<state>INSTALLED_A</state>
			<lastused>1234567890</lastused>
			<jobid>1234</jobid>
			<jobid>4321</jobid>
		</package>
	</runtimeenvironment>

	<runtimeenvironment type="installable">      <!-- Needed for: LIST -->
		<package name="APPS/GRAPH/POVRAY-3.6">
			<description>The Persistence of Vision Raytracer</description>
			<lastupdate>1234567890</lastupdate>
		</package>
		<package name="APPS/BIO/WEKA-3.4.8A">
			<description>WEKA Machine Learning Software</description>
			<lastupdate>1234567890</lastupdate>
		</package>
	</runtimeenvironment>

</response>
\end{lstlisting}




\section{Janitor file system permissions}

In the current implementation the Janitor perl scripts must be executed as root. In order to execute Janitor with the required permissions,
a setuid wrapper has been prepared. During the installation \task{not done yet} the mode of rjanitor will be set to \texttt{u+s},
i.e. the sticky bit is set to make the binary suid root. \task{According to Daniel: ``A future version of the Janitor will get rid of the suid root helper.''}\\

Thus, Janitor is not executed directly. Instead, a dynamic link will be created in \task{libexec or sbin} which is pointing to
the wrapper.\\

It is suggested to create a user and a group "janitor" for the Janitor.\\

% Currently the Janitor must be executed as root. For this a suid root helper
% is needed. It is provided in /opt/janitor/rjanitor.c. If you installed
% the Janitor in another directory then /opt/janitor change the parameter
% of the execv command in rjanitor.c. Then compile the file with\\
% \texttt{\textdollar gcc -o rjanitor rjanitor.c}\\
% and run as root\\
% \texttt{\textdollar chown root:root rjanitor}\\
% \texttt{\textdollar chmod u+s rjanitor}\\
% to make the binary suid root. A future version of the Janitor will get rid
% of the suid root helper.\\
% 
% The Grid Manager does not call the Janitor directly in /opt/janitor but
% calls /opt/nordugrid/libexec/janitor. So a link is needed (as root):\\
% \texttt{\textdollar ln -s /opt/janitor/rjanitor /opt/nordugrid/libexec/janitor}\\
% \\
% It is suggested to create a user and a group "janitor" for the Janitor.\\
% \\
% The Janitor needs a directory for storing information on installed REs:\\
% \texttt{\textdollar mkdir -p /var/lib/nordugrid/janitor}\\
% \texttt{\textdollar chown janitor:janitor /var/lib/nordugrid/janitor}\\
% \\
% It also needs a directory on the shared volume for installing the REs:\\
% % \texttt{\textdollar mkdir -p $<$shared_volume$>$/janitor}\\
% % \texttt{\textdollar chown janitor:janitor $<$shared_volume$>$/janitor}


\subsection{What happens during installation}

Register
\begin{enumerate}
 \item Look up Catalog and find corresponding runtime environments.
 \item Check if dependcies are available (installed or installable)
 \item Store job in \textit{registrationdir}
\end{enumerate}

Deploy
\begin{enumerate}
 \item Load job out of \textit{registrationdir}
 \item Look up Catalog and find corresponding runtime environments.
 \item Check if dependcies are available (installed or installable)
 \item Download RTEs into the \textit{downloaddir}
 \item $\lbrack$ to be continued or skipped $\rbrack$
\end{enumerate}

\subsection{Security Consideration}



Security is a major concern for grid systems. Any additional feature
and especially an automatic software
installation inheritently introduces security threats. This section
addresses those and describes the available solutions to limit
security risks.

In the current installation, every user authorised to execute a job is
also authorised to install a REs. Restrictions are
only imposed on the set of dynamic REs that are available for installation.
Restrictions are imposed by the site admininistrators on the descriptions
that are given by the Catalog that is offering the package. These
descriptions may explicitly mention dynamic REs' names, e.g. a regular expression on
these, or refer to tags of packages that categorise these. However,
the core of these controls lies with the maintainers of the Catalog,
who needs to be trusted.

All dynamic REs are installed in separate directories. The provisioning of
disk space is the duty of the site administrator.  In the current
implementation, the installation is completely transparent to the user:

\begin{itemize}
\item Dynamic REs are not distinguished between {\em installed} and
  {\em installable} in the information system.
\item No status information is given at the time a dynamic RE is installed.
\end{itemize}

Malevolent regular users with respective training in using system exploits
to gain root access are likely to find security holes by regularly
submitted scripts.  The authentication and authentification of users,
together with respective logging, is the major defense against such
attacks. What is consequently left to be protected against are unwanted
side-effects by the installation of software.

The worst case scenario would be the installation of a RE
that overwrites system files. With the current implementation, which is
based solely on tar files, this is barely possible, unless such is
performed by the install scripts that accompany the tar files. However,
hereto the installation would have to be performed by a user with system
priviledges, for which there is no technical requirement.

The installation of packages from the Debian distribution (or other
packages of mainstream Linux distributions) is seeked to reduce the
complexity and burden in the maintenance for dynamic REs. In the
current implementation, Debian packages may be installed only by their
transformation into tar files. With the advent of the interface for
the virtualisation of the grid infrastructure, it is anticipated to
work with native packages of the Debian Linux distribution. The reuse
of packages that passed many eyeballs - as it is the case with packages
from major Linux distribution - security is further increased or becomes
as high as with the operating system underneath virtual clients.

Summarising, there is general concern about the security of grid
computing.  Dynamic REs introduce new dangers since a
manual control at the grid site is substituted by a remote process that
is out the direct supervision of a local site administrator. The signing
of packages by known and directly or indirectly trusted developers is
a good indicator that no malevolent individuals have tampered with the
binary. The site administrators can limit the sources of packages and
specify packages that are eligible or excluded from installations.



% * Programming concept
% ** design decisions: Perl, RDF, Two classes entities with states: jobs and rtes
% ** State transitions of RTEs
% ** State transitions of Jobs
% ** RDF based knowledge base for runtime environments
% ** File based recovery of Jobs and RTEs
% ** Class structure
% ** Interaction with A-REX
% 

\chapter{Installation} 


% ** Dependencies
% *** Ordinary: log4perl and ``Redland RDF Library - Perl Interface''
% *** WebService: libperl-dev
% *** Protege: For maintaining the knowledge base


The Janitor requires the two perl packages listed in
table~\ref{tab:installDependencies}. To have the WebService
interface for the Janitor, the packages listed in
table~\ref{tab:installDependenciesOptional}
need to be installed before
the build process is. The Perl modules are available on CPAN and ship
with all major Linux distributions.  

\begin{table}[!h]
   \begin{center}
        \mycaption{Required perl packages for the Janitor.}
		   {Log4perl is used for the internal logging of the
		   Janitor, while the Redland RDF library is used
		   for accessing the knowledge base (catalog) of
		   Runtime Environments.}
        \label{tab:installDependencies}
	\begin{tabular}{|p{3cm}|p{7cm}|}
	\hline
	   liblog-log4perl-perl & \textit{Log4perl is a port of the log4j logging package}\\
	\hline
	   librdf-perl          & \textit{Perl language bindings for the Redland RDF library}\\
	\hline
	\end{tabular} 
   \end{center}
\end{table}
\begin{table}[!h]
   \begin{center}
        \mycaption{Optional libraries for the Janitor.}{The
		   library libperl-dev provides the required header files to link the 
                   WebService to the Perl interpreter.}
        \label{tab:installDependenciesOptional}
	\begin{tabular}{|p{3cm}|p{7cm}|}
	\hline
	   libperl-dev & \textit{ Perl library: development files}\\
	\hline
	\end{tabular}
   \end{center}
\end{table}
\forcelinebreak

If you are using regular Debian or Ubuntu packages, then the Janitor
can be installed as root by "apt-get install nordugrid-arc1-janitor".
Installing it will not drag other components of ARC with it, since the
Janitor can be used in its own right -- or in conjunction with another
grid system, possibly. Packages for Redhat/Fedora and SuSE/OpenSuSE are
also provided, the redland library however may not yet be available for
those systems.

The Janitor source code is shipped as a part of the regular ARC-NOX
source tree.  If you are compiling the sources yourself, the default
is to have the A-REX grid manager technically prepared to interact
with the Janitor.
The interaction can be prohibited
with the \textit{configure} flags \textit{--disable-janitor-service}
for the complete janitor or \textit{--disable-janitor-webservice} for
only the Web Service support.

Furthermore many users will want to consider installing the ontology editor 
Prot\`eg\`e\footnote{\href{http://protege.stanford.edu}{http://protege.stanford.edu}}
to easily maintain the knowledge database of installable
packages.  At the time of writing, no Linux distribution is offering
packages for this fine tool. However, the basic editing can also be
performed fairly easily without that tool, and everyone is working on
simplifying that process.


\section{Configuration}\label{sec:janitorConfiguration}

The current version of the Janitor can be configured using the
common file \textit{arc.conf}. It is expected in the configuration
directory \textit{etc}. The Janitor is using the environment
variable \textit{NORDUGRID\_CONFIG} to determine the location of the
corresponding file. If that variable is not set, the default location
\textit{/etc/arc.conf} will be used.  The parameter \texttt{use\_janitor} in the
\lbrack grid-manager\rbrack section has to be set in order to tell A-REX
whether to use Janitor or not. By default, Janitor is not used. Use the value
\texttt{"1"} to enable Janitor.

Janitor is configured through parameters
in the section \lbrack janitor\rbrack. Table~\ref{tab:arcConfTags}
describes the available tags for the Janitor's configuration.

\begin{landscape}
\begin{table}[!h]
   \begin{center}
        \mycaption{Tags usable in \textit{arc.conf} within the section janitor.}{Tags usable in \textit{arc.conf} within the section janitor.}
	\label{tab:arcConfTags}
	\begin{longtable}{|p{3cm}|p{10cm}||p{10cm}|}
	\hline
	   \textbf{tag}    & \textbf{example}                      & \textbf{description}\\
        \hline
	   uid             & "root"                                & The effective uid. \\
	   gid             & "0"                                   & The effective gid. \\
	   registrationdir & "/var/spool/nordugrid/janitor"        & Directory where we the current states of jobs are kept. \\
	   catalog         & "/var/spool/nordugrid/janitor/catalog/knowarc.rdf"& URL of the catalog containing the package information.\\
	   downloaddir     & "/var/spool/nordugrid/janitor/download" & Directory for downloads \\
	   installationdir & "/var/spool/nordugrid/janitor/runtime"& Directory for installation of packages                   \\
	   jobexpirytime   & "7200"                                & If a job is older than this, it is considered dead and assigned to be removal pending.\\
	   rteexpirytime   & "36"                                  & If a runtime environment was not used for this time, it will be assigned to be removal pending.\\
	   allow\_base     & "*"                                   & Allow rule for base packages. \\
	   deny\_base      & "debian::etch"                        & Deny rule for base packages.\\
	   allow\_rte      & "*"                                   & Allow rule for base packages. \\
	   deny\_rte       & "APPS/MATH/ELMER-5.0.2"               & Deny rule for base packages. \\
	   logconf         & "/opt/nordugrid/etc/log.conf"         & Location of the logging configuration file for janitor.\\
	\hline
	\end{longtable}
   \end{center}
\end{table}
\end{landscape}

The \texttt{uid} and the \texttt{gid} are defining which effective user id
(uid) and group id (gid) shall be used for the Janitor.

The \texttt{registrationdir} describes the directory in which the
subdirectories \texttt{jobs} and \texttt{rtes} will be created.
In these directories the states of the jobs and the runtime environments
are stored. Please recall that the Janitor does not use a database as
a backend, but all communication between invocations are performed via
files in those folders.

The knowledge base of installable packages is specified by the parameter
\texttt{catalog}.  Its value can be any kind of URL pointing to a file
written in the Resource Description Framework (RDF) format.  One should
not light-heartedly use a remote address for this purpose. Such a remote
source needs to be trusted, since any runtime environment specified in
a catalog (if the package description matches constraints by the local
site administrator) may possibly be installed by regular grid users.

The specification of the RDF file will be explained in detail in
section~\ref{sec:catalog}.  The parameter \texttt{downloaddir} assigns
the directory to which the installation files will be saved after they
have been downloaded or copied from the repository which was specified by
the catalog. Please remember: the URL in arc.conf indicates the location
of the catalog. And the URLs somehow specified in the catalog specify
the location from where to download the runtime environment.

The \texttt{installationdir} finally specifies the directory into which
all packages will be installed. This directory needs to be available
for all computing nodes for the execution of arbitrary programs, most
commonly by using it as a shared NFS volume.

If the configuration file furthermore contains the \texttt{runtimedir}
tag within the section \texttt{grid-manager}, the Janitor will also
create a symbolic link in the \texttt{runtimedir} pointing to the
configuration script of the installation performed by the Janitor.
The tags \texttt{jobexpirytime} and \texttt{rteexpirytime} are used
for an automated cleanup and is defined in seconds.  The default
value for the \texttt{jobexpirytime} is seven days and for
the \texttt{rteexpirytime} three days.  The additional tags
\texttt{allow\_base} \texttt{deny\_base} \texttt{allow\_rte} and
\texttt{deny\_rte} are used to include or exclude certain base packages
or runtime environments of the catalog. This feature is useful, if the
catalog is maintained by a higher organization. But again: you need to
trust it.

The path to the log4perl configuration file is defined by the tag
\texttt{logconf}.  Examples on how to configure ARC and log4perl are
provided in the Listings~\ref{lst:arcConf} and ~\ref{lst:logConf}.


\lstsetCONFIGURE
\begin{lstlisting}[
        label=lst:arcConf,
        caption={ [Example \textit{arc.conf} settings for janitor.]
                  \textbf{Example \textit{arc.conf} settings for janitor.}}
        ]
[janitor]
enabled="1"
logconf="/opt/nordugrid/etc/log.conf"
registrationdir="/var/spool/nordugrid/janitor"
installationdir="/var/spool/nordugrid/janitor/runtime"
downloaddir="/var/spool/nordugrid/janitor/download"
jobexpirytime="7200"
rteexpirytime="36"
uid="root"
gid="0"
allow_base="*"
allow_rte="*"

[janitor/nordugrid]
catalog="/var/spool/nordugrid/janitor/catalog/knowarc.rdf"
\end{lstlisting}

It should be noted that the downloaddir or the installationdir specified
in arc.conf could be any directory. Those will not be prepared by the
package for the Linux distribution but need be created by the administrator
manually after the Janitor has been installed. This also holds for the
catalog.

When working with several catalogs, then the multiple catalog lines can
be placed into the same arc.conf file. But every must go into its own block
as separated with \[janitor/someName\] directives.

\lstsetCONFIGURE
\begin{lstlisting}[
        label=lst:logConf,
        caption={ [Example \textit{log.conf} settings for janitor.]
                  \textbf{Example \textit{log.conf} settings for janitor.}}
        ]
# Master Loglevel
# [OFF | DEBUG | INFO | WARN | ERROR | FATAL]
#log4perl.threshold = OFF

log4perl.rootLogger = WARN, DebugLog, MainLog, ErrorLog
log4perl.appender.DebugLog = Log::Log4perl::Appender::Screen
log4perl.appender.DebugLog.layout = PatternLayout
log4perl.appender.DebugLog.layout.ConversionPattern = [%C] %d %p> %m%n

log4perl.appender.MainLog = Log::Log4perl::Appender::File
log4perl.appender.MainLog.Threshold = DEBUG
log4perl.appender.MainLog.filename = /var/log/arc/janitor.log
log4perl.appender.MainLog.layout = PatternLayout
log4perl.appender.MainLog.layout.ConversionPattern = %d %p> %m%n

log4perl.appender.ErrorLog = Log::Log4perl::Appender::File
log4perl.appender.ErrorLog.Threshold = ERROR
log4perl.appender.ErrorLog.filename = /var/log/arc/janitor_error.log

log4perl.appender.ErrorLog.layout = PatternLayout
log4perl.appender.ErrorLog.layout.ConversionPattern = %d %p> %m%n
\end{lstlisting}


% ** Configuring arc.conf
% *** Where to store the data of janitor
% ** Configuring log.conf
% *** Where to store the log of janitor

\section{Limitations}

The Janitor was designed to be used for UNIX-compatible operating systems
and tested for various Linux distributions. It should also be functional
on MaxOS X and Windows with Cygwin or coLinux.  The porting of the Janitor
to other platforms has not yet been addressed.

The ARC middleware is not ultimately essential for dynamic Runtime
Environments.  All the Perl code would be functional with any Grid
middleware.


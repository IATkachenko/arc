#!/bin/sh

# Wrapper for download to allow copying the input files to a remote LRMS after
# downloading them here.
# Will still work if LRMS is local.

#################
# General setup #
#################

if [ -z $NORDUGRID_LOCATION ]; then
	LIBEXECDIR="@libexecdir@"
else
	LIBEXECDIR="${NORDUGRID_LOCATION}/libexec"
fi

# Include remote LRMS functions
REMOTE_LRMS_FUNCTIONS="${LIBEXECDIR}/remote-lrms-functions"
if [ -r ${REMOTE_LRMS_FUNCTIONS} ]; then
	. ${REMOTE_LRMS_FUNCTIONS}

	read_gw_conf $@
	LOCAL_LRMS=$?
else 
	errormsg "${REMOTE_LRMS_FUNCTIONS} not readable - disabling remote LRMS!"
	LOCAL_LRMS='1'
fi

#debugmsg "wrapper script!!"

DL_SCRIPT="${0}.bin"

#debugmsg "calling ${DL_SCRIPT} with args"
${DL_SCRIPT} $@
ret=$?
if [ $ret -ne '0' ]; then
	errormsg "${DL_SCRIPT} failed with err $ret"
	exit $ret
fi

#debugmsg "LOCAL_LRMS ${LOCAL_LRMS}"

if [ ${LOCAL_LRMS} -eq '0' ]; then
	session_dir=""
	find_session_dir $@
	if [ -z $session_dir ]; then
		errormsg "session_dir not found - no upload to resource"
		exit 1
	fi
	debugmsg "uploading session_dir $session_dir"
	upload_session_dir $session_dir
	ret=$?
	if [ $ret -ne '0' ]; then
		errormsg "upload session failed! ($ret) - ignoring"
	fi
#else
	#debugmsg "local LRMS ${LOCAL_LRMS} - no upload to resource required"
fi

exit $ret

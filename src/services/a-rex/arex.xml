<?xml version="1.0"?>
<ArcConfig
  xmlns="http://www.nordugrid.org/schemas/ArcConfig/2007"
  xmlns:tcp="http://www.nordugrid.org/schemas/ArcMCCTCP/2007"
  xmlns:arex="http://www.nordugrid.org/schemas/a-rex/Config"
>
  <!-- Common configuration of the daemon -->
  <Server>
    <Pidfile>/var/run/arched.pid</Pidfile>
    <Logger level="VERBOSE">/var/log/arched.log</Logger>
  </Server>
  <!-- Where to find plugins -->
  <ModuleManager>
    <Path>/opt/arc/lib/arc/</Path>
  </ModuleManager>
  <!-- Simply load all needed plugins -->
  <Plugins><Name>mcctcp</Name></Plugins>
  <Plugins><Name>mcctls</Name></Plugins>
  <Plugins><Name>mcchttp</Name></Plugins>
  <Plugins><Name>mccsoap</Name></Plugins>
  <Plugins><Name>arcpdc</Name></Plugins>
  <Plugins><Name>identitymap</Name></Plugins>
  <Plugins><Name>arex</Name></Plugins>
  <!-- Create a chain -->
  <Chain>
    <!-- TCP listening socket -->
    <Component name="tcp.service" id="tcp">
      <next id="tls"/>
      <tcp:Listen><tcp:Port>60000</tcp:Port></tcp:Listen>
    </Component>
    <!-- Transport-level security -->
    <Component name="tls.service" id="tls">
      <next id="http"/>
      <!-- Location of server's security keys -->
      <KeyPath>/etc/grid-security/hostkey.pem</KeyPath>
      <CertificatePath>/etc/grid-security/hostcert.pem</CertificatePath>
      <CACertificatesDir>/etc/grid-security/certificates</CACertificatesDir>
      <!-- Evaluate requestor's identity into local identity.
           Comment it if no user mapping is needed. -->
      <SecHandler name="identity.map" id="map" event="incoming">
        <!-- Safe choice if all other rules failed -->
        <PDP name="allow.pdp"><LocalName>nobody</LocalName></PDP>
      </SecHandler>
    </Component>
    <!-- HTTP processing is done here -->
    <Component name="http.service" id="http">
      <next id="soap">POST</next>
      <next id="plexer">GET</next>
    </Component>
    <!-- This one parses content into XML tree -->
    <Component name="soap.service" id="soap">
      <next id="plexer"/>
    </Component>
    <!-- Directing messages to proper service -->
    <Plexer name="plexer.service" id="plexer">
      <next id="a-rex">^/arex.*</next>
    </Plexer>
    <!-- A-Rex service -->
    <Service name="a-rex" id="a-rex">
      <!-- Optional endpoint element is advised in case of multiple IP adresses -->
      <arex:endpoint>https://localhost:60000/arex</arex:endpoint>
      <!-- Use information generated by identity.map plugin or default provided below -->
      <arex:usermap><arex:defaultLocalName>nobody</arex:defaultLocalName></arex:usermap>
      <!-- grid-manager part of a-rex requires legacy configuration file.
           Use arc_arex.conf example or write own. -->
      <arex:gmconfig>/etc/arc_arex.conf</arex:gmconfig>
    </Service>
  </Chain>
</ArcConfig>


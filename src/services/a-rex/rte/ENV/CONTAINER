# description: executes the job inside singularity container
# param:SINGULARITY_IMAGE:string:NULL:singularity image or tree per VO, key:value comma separated, key default if VO not matched
# param:SINGULARITY_OPTIONS:string: :singularity options

# EXAMPLE settings
# SINGULARITY_IMAGE=default:/cvmfs/atlas.cern.ch/repo/containers/fs/singularity/x86_64-centos6,atlas:/cvmfs/atlas.cern.ch/repo/containers/fs/singularity/x86_64-centos6,belle:/ceph/sys/singularity/container/belle.img
# SINGULARITY_OPTIONS=-B /etc/grid-security/certificates,/cvmfs,/ceph/grid,/data0

SINGULARITY_OPTIONS="${SINGULARITY_OPTIONS:-}"
SINGULARITY_IMAGE="${SINGULARITY_IMAGE:-}"

DEFAULT_IMAGE="NULL"

if [ "x$1" = "x0" ]; then

    # get VO
    vo=`arcproxy -P $joboption_controldir/job.$joboption_gridid.proxy -i vomsVO 2> /dev/null`
    BIFS=$IFS
    IFS=","
    read -ra ADDR <<< $SINGULARITY_IMAGE
    # find default image per VO
    for i in "${ADDR[@]}"; do
        IFS=":"
        read -ra BDDR <<< $i
	# catchall if VO not in config var
	if [ "xdefault" = "x${BDDR[0]}" ]; then
	    DEFAULT_IMAGE=${BDDR[1]}
	fi
	if [ "x$vo" = "x${BDDR[0]}" ] ; then
	    IMAGE=${BDDR[1]}
	fi
    done
    IFS=$BIFS

    IMAGE="${IMAGE:-$DEFAULT_IMAGE}"

    # explicit image, NULL skips container
    IMAGE="${2:-$IMAGE}"
    # unquote IMAGE
    temp="${IMAGE%\"}"
    temp="${temp#\"}"
    IMAGE=$temp

    if [ "x$IMAGE" != "xNULL" ] ; then
       joboption_args="/usr/bin/singularity exec $SINGULARITY_OPTIONS --home \${RUNTIME_JOB_DIR} $IMAGE $joboption_args"
    fi
fi

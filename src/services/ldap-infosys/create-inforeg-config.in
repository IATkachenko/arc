#!/bin/bash

# Create info registration config for the NorduGrid/ARC information system

ARC_LOCATION=${ARC_LOCATION:-@prefix@}
if [ ! -d "$ARC_LOCATION" ]; then
    echo "ARC_LOCATION ($ARC_LOCATION) not found"
    exit 1
fi

arcconfig_parser=${ARC_LOCATION}/@pkglibexecsubdir@/arcconfig-parser

ARC_CONFIG=${ARC_CONFIG:-/etc/arc.conf}
if [ ! -r "$ARC_CONFIG" ]; then
    echo "ARC configuration file ($ARC_CONFIG) not found"
    echo "If this file is in a non-standard place it can be set with the"
    echo "  ARC_CONFIG environment variable"
    exit 1
fi

# Check for infosys block
if ! ${arcconfig_parser} -c ${ARC_CONFIG} -b infosys; then
    echo "Missing [infosys] configuration block"
    exit 1
fi

eval $(${arcconfig_parser} -c ${ARC_CONFIG} -b common -e bash)
eval $(${arcconfig_parser} -c ${ARC_CONFIG} -b cluster -e bash)

# These options need to come from the infosys block, not from common
unset CONFIG_logfile
unset CONFIG_user
unset CONFIG_port

eval $(${arcconfig_parser} -c ${ARC_CONFIG} -b infosys -e bash)
eval $(${arcconfig_parser} -c ${ARC_CONFIG} -b infosys/ldap -e bash)

bdii_user=$CONFIG_user
if [ -z "$bdii_user" ]; then
    # Get ldap user from passwd
    bdii_user=`getent passwd ldap openldap | sed 's/:.*//;q'`
    if [ -z "$bdii_user" ]; then
	echo "Warning, could not find ldap or openldap user"
	echo "resorting to using the root user"
	bdii_user=root
    fi
fi

# directories
registrationlog=${CONFIG_registrationlog:-/var/log/arc/inforegistration.log}
mkdir -p `dirname $registrationlog`
touch ${registrationlog}
chown ${bdii_user}: ${registrationlog}

infosys_ldap_run_dir=${CONFIG_infosys_ldap_run_dir:-/var/run/arc/infosys}
mkdir -p ${infosys_ldap_run_dir}
chown ${bdii_user}: ${infosys_ldap_run_dir}

registrationconf=${infosys_ldap_run_dir}/grid-info-resource-register.conf

printregldif () {
    cat <<-EOF

	# Registration "$rootdn" -> "$targetsuffix"
	dn: Mds-Vo-Op-name=register, $targetsuffix
	regtype: mdsreg2
	reghn: $reghn
	regport: $regport
	regperiod: $regperiod
	type: ldap
	hn: $hn
	port: $port
	rootdn: $rootdn
	ttl: $ttl
	timeout: $timeout
	mode: cachedump
	cachettl: $cachettl
	bindmethod: $bindmethod
	EOF
}

echo "# This file was automatically generated by $0." > $registrationconf
echo "# Do not modify." >> $registrationconf
echo >> $registrationconf

(
    # Cluster registration blocks
    for p in $(${arcconfig_parser} -c ${ARC_CONFIG} -b infosys/cluster/registration -s); do
	(
	    eval $(${arcconfig_parser} -c ${ARC_CONFIG} -b ${p} -e bash)

	    targetsuffix=${CONFIG_targetsuffix:-"Mds-Vo-name=$p,o=grid"}
	    reghn=${CONFIG_targethostname:-"targethostname.not.set"}
	    regport=${CONFIG_targetport:-2135}
	    hn=${CONFIG_registranthostname:-$CONFIG_hostname}
	    port=${CONFIG_registrantport:-${CONFIG_port:-2135}}
	    rootdn=${CONFIG_registrantsuffix:-"nordugrid-cluster-name=$hn,Mds-Vo-name=local,o=grid"}
	    regperiod=${CONFIG_regperiod:-120}
	    ttl=${CONFIG_ttl:-$(( $regperiod * 2 ))}
	    timeout=${CONFIG_timeout:-45}
	    cachettl=${CONFIG_cachettl:-0}
	    sizelimit=${CONFIG_sizelimit:-0}
	    bindmethod=${CONFIG_bindmethod:-ANONYM-ONLY}

	    printregldif >> $registrationconf
	)
    done

    # SE registration blocks
    for seentry in $(${arcconfig_parser} -c ${ARC_CONFIG} -b infosys/se -s); do
	(
	    eval $(${arcconfig_parser} -c ${ARC_CONFIG} -b ${seentry} -e bash)
	    grep -q /registration <<< ${CONFIG___block_name} && continue
	    sename=${CONFIG___block_name}

	    for p in $(${arcconfig_parser} -c ${ARC_CONFIG} -b ${seentry}/registration -s); do
		(
		    eval $(${arcconfig_parser} -c ${ARC_CONFIG} -b ${p} -e bash)

		    targetsuffix=${CONFIG_targetsuffix:-"Mds-Vo-name=$p,o=grid"}
		    reghn=${CONFIG_targethostname:-"targethostname.not.set"}
		    regport=${CONFIG_targetport:-2135}
		    hn=${CONFIG_registranthostname:-$CONFIG_hostname}
		    port=${CONFIG_registrantport:-${CONFIG_port:-2135}}
		    rootdn=${CONFIG_registrantsuffix:-"nordugrid-se-name=$sename:$hn,Mds-Vo-name=local,o=grid"}
		    regperiod=${CONFIG_regperiod:-120}
		    ttl=${CONFIG_ttl:-$(( $regperiod * 2 ))}
		    timeout=${CONFIG_timeout:-45}
		    cachettl=${CONFIG_cachettl:-0}
		    sizelimit=${CONFIG_sizelimit:-0}
		    bindmethod=${CONFIG_bindmethod:-ANONYM-ONLY}

		    printregldif >> $registrationconf
		)
	    done
	)
    done
)

exit 0
